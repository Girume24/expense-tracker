<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Expenses – Expense Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="description" content="Mobile-style expense tracker you can install on your phone and use offline." />
  <meta name="application-name" content="My Expenses" />
  <meta name="apple-mobile-web-app-title" content="My Expenses" />
  <meta name="theme-color" content="#020617" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" type="image/svg+xml" href="icon.svg" />
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
</head>
<body class="bg-slate-900 text-slate-50">
  <!-- App shell constrained to a phone-like width -->
  <div class="min-h-screen flex justify-center">
    <div class="relative flex min-h-screen w-full max-w-md flex-col bg-slate-950 text-slate-50 shadow-xl">
      <!-- App bar -->
      <header class="sticky top-0 z-20 border-b border-slate-800 bg-slate-950/95 backdrop-blur">
        <div class="px-4 pt-4 pb-3 flex items-center justify-between gap-3">
          <div>
            <h1 class="text-lg font-semibold tracking-tight">Expense Tracker</h1>
            <p class="text-[11px] text-slate-400">Personal expense app on this device only.</p>
          </div>
          <div class="text-right">
            <p id="today-label" class="text-[11px] text-slate-400"></p>
          </div>
        </div>
      </header>

      <!-- Screens -->
      <main class="flex-1 overflow-y-auto bg-slate-950 px-4 pb-20 pt-3 space-y-4">
        <!-- Add screen -->
        <section id="screen-add" class="space-y-4">
          <!-- Compact summary at top -->
          <section aria-label="Summary" class="grid grid-cols-3 gap-2 text-center">
            <div class="rounded-xl border border-slate-800 bg-slate-900/70 px-2 py-2">
              <p class="text-[10px] font-medium text-slate-400 uppercase tracking-wide">All-time</p>
              <p id="summary-total-all" class="mt-1 text-sm font-semibold text-slate-50">0.00</p>
            </div>
            <div class="rounded-xl border border-slate-800 bg-slate-900/70 px-2 py-2">
              <p class="text-[10px] font-medium text-slate-400 uppercase tracking-wide">This month</p>
              <p id="summary-total-month" class="mt-1 text-sm font-semibold text-slate-50">0.00</p>
            </div>
            <div class="rounded-xl border border-slate-800 bg-slate-900/70 px-2 py-2">
              <p class="text-[10px] font-medium text-slate-400 uppercase tracking-wide">Entries</p>
              <p id="summary-count" class="mt-1 text-sm font-semibold text-slate-50">0</p>
            </div>
          </section>

          <!-- Add expense form -->
          <section class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 space-y-3">
            <div class="flex items-start justify-between gap-2">
              <div>
                <h2 class="text-base font-semibold text-slate-50">Add expense</h2>
                <p class="mt-0.5 text-[11px] text-slate-400">Quickly log what you spent.</p>
              </div>
            </div>

            <p id="editing-indicator" class="hidden text-[11px] text-amber-50 bg-amber-900/40 border border-amber-500 rounded-lg px-3 py-2 flex items-center justify-between gap-2">
              <span>You are editing an existing expense.</span>
              <button type="button" id="cancel-edit-btn" class="text-amber-50 font-medium underline underline-offset-2">Cancel</button>
            </p>

            <form id="expense-form" class="space-y-3">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label for="amount-input" class="block text-[11px] font-medium text-slate-300 mb-1">Amount</label>
                  <div class="relative">
                    <span class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-2 text-xs text-slate-500">+</span>
                    <input
                      id="amount-input"
                      name="amount"
                      type="number"
                      step="0.01"
                      min="0.01"
                      inputmode="decimal"
                      required
                      class="block w-full rounded-lg border border-slate-700 bg-slate-900 pl-6 pr-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      placeholder="0.00"
                    />
                  </div>
                </div>

                <div>
                  <label for="category-input" class="block text-[11px] font-medium text-slate-300 mb-1">Category</label>
                  <select
                    id="category-input"
                    name="category"
                    class="block w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    required
                  >
                    <option value="" disabled selected>Select a category</option>
                    <option value="Food">Food</option>
                    <option value="Transport">Transport</option>
                    <option value="Housing">Housing</option>
                    <option value="Utilities">Utilities</option>
                    <option value="Entertainment">Entertainment</option>
                    <option value="Health">Health</option>
                    <option value="Shopping">Shopping</option>
                    <option value="Travel">Travel</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
              </div>

              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label for="date-input" class="block text-[11px] font-medium text-slate-300 mb-1">Date</label>
                  <input
                    id="date-input"
                    name="date"
                    type="date"
                    required
                    class="block w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>
                <div>
                  <label for="description-input" class="block text-[11px] font-medium text-slate-300 mb-1">
                    Description <span class="text-slate-500 font-normal">(optional)</span>
                  </label>
                  <input
                    id="description-input"
                    name="description"
                    type="text"
                    maxlength="120"
                    class="block w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                    placeholder="e.g. Groceries at supermarket"
                  />
                </div>
              </div>

              <p id="form-error" class="hidden text-[11px] text-red-300"></p>

              <div class="flex justify-between items-center pt-1">
                <p class="text-[10px] text-slate-500">Stored locally in this browser. No account needed.</p>
                <div class="flex gap-2">
                  <button
                    type="button"
                    id="reset-form-btn"
                    class="inline-flex items-center rounded-full border border-slate-600 px-3 py-1 text-[11px] font-medium text-slate-100 hover:bg-slate-800"
                  >
                    Reset
                  </button>
                  <button
                    type="submit"
                    id="submit-btn"
                    class="inline-flex items-center rounded-full bg-blue-500 px-3 py-1.5 text-[11px] font-semibold text-white shadow-sm hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 focus:ring-offset-slate-900"
                  >
                    Add expense
                  </button>
                </div>
              </div>
            </form>
          </section>

          <p class="text-[11px] text-slate-500 text-center px-4">
            On Android: open this page in Chrome, tap the menu button (three dots), then "Add to Home screen", then "Install". Open it from your home screen like a normal app.
          </p>
        </section>

        <!-- History / list screen -->
        <section id="screen-history" class="space-y-4 hidden">
          <!-- Filters -->
          <section class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 space-y-3">
            <div class="flex items-start justify-between gap-2">
              <div>
                <h2 class="text-base font-semibold text-slate-50">Filters</h2>
                <p class="mt-0.5 text-[11px] text-slate-400">Filter by category, date range, or text.</p>
              </div>
            </div>

            <div class="space-y-3">
              <div>
                <label for="filter-category" class="block text-[11px] font-medium text-slate-300 mb-1">Category</label>
                <select
                  id="filter-category"
                  class="block w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                >
                  <option value="all">All categories</option>
                  <option value="Food">Food</option>
                  <option value="Transport">Transport</option>
                  <option value="Housing">Housing</option>
                  <option value="Utilities">Utilities</option>
                  <option value="Entertainment">Entertainment</option>
                  <option value="Health">Health</option>
                  <option value="Shopping">Shopping</option>
                  <option value="Travel">Travel</option>
                  <option value="Other">Other</option>
                </select>
              </div>

              <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label for="filter-from" class="block text-[11px] font-medium text-slate-300 mb-1">From date</label>
                  <input
                    id="filter-from"
                    type="date"
                    class="block w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>
                <div>
                  <label for="filter-to" class="block text-[11px] font-medium text-slate-300 mb-1">To date</label>
                  <input
                    id="filter-to"
                    type="date"
                    class="block w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-50 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>
              </div>

              <div>
                <label for="filter-search" class="block text-[11px] font-medium text-slate-300 mb-1">Text search</label>
                <input
                  id="filter-search"
                  type="text"
                  placeholder="Search in description or category"
                  class="block w-full rounded-lg border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-slate-50 placeholder:text-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                />
              </div>

              <div class="flex justify-between items-center pt-1">
                <button
                  type="button"
                  id="clear-filters-btn"
                  class="inline-flex items-center rounded-full border border-slate-600 px-3 py-1.5 text-[11px] font-medium text-slate-100 hover:bg-slate-800"
                >
                  Clear filters
                </button>
                <button
                  type="button"
                  id="clear-all-btn"
                  class="inline-flex items-center rounded-full border border-red-500/80 px-3 py-1.5 text-[11px] font-medium text-red-200 hover:bg-red-950/60"
                >
                  Clear all data
                </button>
              </div>

              <p class="text-[10px] text-slate-500">
                Filters change only what you see. "Clear all data" removes every expense stored in this browser.
              </p>
            </div>
          </section>

          <!-- Expenses list -->
          <section class="rounded-2xl border border-slate-800 bg-slate-900/70 p-4 space-y-3">
            <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
              <div>
                <h2 class="text-base font-semibold text-slate-50">History</h2>
                <p id="list-summary" class="mt-0.5 text-[11px] text-slate-400">No expenses yet.</p>
              </div>
              <div class="flex gap-2 justify-end">
                <button
                  type="button"
                  id="export-json-btn"
                  class="inline-flex items-center rounded-full border border-slate-600 px-3 py-1.5 text-[11px] font-medium text-slate-100 hover:bg-slate-800"
                >
                  Export JSON
                </button>
              </div>
            </div>

            <div
              id="no-expenses"
              class="mt-2 border border-dashed border-slate-700 rounded-lg px-4 py-6 text-center text-sm text-slate-400"
            >
              No expenses recorded yet. Add your first expense on the Add tab.
            </div>

            <div id="table-wrapper" class="mt-2 overflow-x-auto hidden">
              <table class="min-w-full text-xs">
                <thead>
                  <tr class="border-b border-slate-800 bg-slate-900">
                    <th scope="col" class="px-3 py-2 text-left font-medium text-slate-400 text-[10px] uppercase tracking-wide whitespace-nowrap">Date</th>
                    <th scope="col" class="px-3 py-2 text-left font-medium text-slate-400 text-[10px] uppercase tracking-wide whitespace-nowrap">Category</th>
                    <th scope="col" class="px-3 py-2 text-left font-medium text-slate-400 text-[10px] uppercase tracking-wide">Description</th>
                    <th scope="col" class="px-3 py-2 text-right font-medium text-slate-400 text-[10px] uppercase tracking-wide whitespace-nowrap">Amount</th>
                    <th scope="col" class="px-3 py-2 text-right font-medium text-slate-400 text-[10px] uppercase tracking-wide whitespace-nowrap">Actions</th>
                  </tr>
                </thead>
                <tbody id="expense-tbody" class="divide-y divide-slate-800">
                  <!-- Rows injected by JavaScript -->
                </tbody>
              </table>
            </div>
          </section>

          <p class="text-[10px] text-slate-500 text-center px-4">
            Your data never leaves this device. Use "Export JSON" regularly if you want a manual backup.
          </p>
        </section>
      </main>
    </div>
  </div>

  <!-- Bottom tab bar -->
  <nav class="fixed inset-x-0 bottom-0 z-30 border-t border-slate-800 bg-slate-950/95 backdrop-blur">
    <div class="mx-auto flex max-w-md">
      <button
        type="button"
        data-tab-target="add"
        class="flex-1 py-2.5 flex flex-col items-center justify-center text-xs font-medium text-blue-400"
      >
        <span>Add</span>
        <span class="tab-indicator mt-1 h-0.5 w-8 rounded-full bg-blue-400"></span>
      </button>
      <button
        type="button"
        data-tab-target="history"
        class="flex-1 py-2.5 flex flex-col items-center justify-center text-xs font-medium text-slate-400"
      >
        <span>History</span>
        <span class="tab-indicator mt-1 h-0.5 w-8 rounded-full bg-blue-400 opacity-0"></span>
      </button>
    </div>
  </nav>

  <script>
    (function () {
      const STORAGE_KEY = "expense-tracker-v1";
      let expenses = [];
      let editingId = null;
      let activeTab = "add";

      const amountInput = document.getElementById("amount-input");
      const categoryInput = document.getElementById("category-input");
      const dateInput = document.getElementById("date-input");
      const descriptionInput = document.getElementById("description-input");
      const expenseForm = document.getElementById("expense-form");
      const resetFormBtn = document.getElementById("reset-form-btn");
      const submitBtn = document.getElementById("submit-btn");
      const formError = document.getElementById("form-error");
      const editingIndicator = document.getElementById("editing-indicator");
      const cancelEditBtn = document.getElementById("cancel-edit-btn");

      const filterCategory = document.getElementById("filter-category");
      const filterFrom = document.getElementById("filter-from");
      const filterTo = document.getElementById("filter-to");
      const filterSearch = document.getElementById("filter-search");
      const clearFiltersBtn = document.getElementById("clear-filters-btn");
      const clearAllBtn = document.getElementById("clear-all-btn");
      const exportJsonBtn = document.getElementById("export-json-btn");

      const summaryTotalAll = document.getElementById("summary-total-all");
      const summaryTotalMonth = document.getElementById("summary-total-month");
      const summaryCount = document.getElementById("summary-count");

      const todayLabel = document.getElementById("today-label");
      const tableWrapper = document.getElementById("table-wrapper");
      const expenseTbody = document.getElementById("expense-tbody");
      const noExpenses = document.getElementById("no-expenses");
      const listSummary = document.getElementById("list-summary");

      const tabButtons = document.querySelectorAll("[data-tab-target]");
      const screenAdd = document.getElementById("screen-add");
      const screenHistory = document.getElementById("screen-history");

      const currencyFormatter = new Intl.NumberFormat(undefined, {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });

      function setTodayLabel() {
        if (!todayLabel) return;
        const now = new Date();
        todayLabel.textContent = now.toLocaleDateString(undefined, {
          year: "numeric",
          month: "short",
          day: "numeric",
          weekday: "short"
        });
      }

      function getTodayDateString() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const day = String(now.getDate()).padStart(2, "0");
        return year + "-" + month + "-" + day;
      }

      function setDefaultDate() {
        if (dateInput) {
          dateInput.value = getTodayDateString();
        }
      }

      function showFormError(message) {
        if (!formError) return;
        if (!message) {
          formError.textContent = "";
          formError.classList.add("hidden");
          return;
        }
        formError.textContent = message;
        formError.classList.remove("hidden");
      }

      function loadExpenses() {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (!raw) {
            expenses = [];
            return;
          }
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed)) {
            expenses = parsed
              .filter(function (item) {
                return (
                  item &&
                  typeof item.id === "number" &&
                  typeof item.amount === "number" &&
                  typeof item.date === "string"
                );
              })
              .map(function (item) {
                return {
                  id: item.id,
                  amount: item.amount,
                  category: item.category || "Other",
                  date: item.date,
                  description: item.description || ""
                };
              });
          } else {
            expenses = [];
          }
        } catch (err) {
          console.error("Failed to load expenses from localStorage", err);
          expenses = [];
        }
      }

      function saveExpenses() {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(expenses));
        } catch (err) {
          console.error("Failed to save expenses to localStorage", err);
        }
      }

      function formatDate(dateStr) {
        if (!dateStr) return "";
        const d = new Date(dateStr + "T00:00:00");
        if (Number.isNaN(d.getTime())) return dateStr;
        return d.toLocaleDateString(undefined, {
          year: "numeric",
          month: "short",
          day: "numeric"
        });
      }

      function parseDate(dateStr) {
        if (!dateStr) return null;
        const d = new Date(dateStr + "T00:00:00");
        if (Number.isNaN(d.getTime())) return null;
        return d;
      }

      function calculateSummary() {
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth();

        let totalAll = 0;
        let totalMonth = 0;

        for (let i = 0; i < expenses.length; i++) {
          const exp = expenses[i];
          totalAll += exp.amount;
          const d = parseDate(exp.date);
          if (!d) continue;
          if (d.getFullYear() === currentYear && d.getMonth() === currentMonth) {
            totalMonth += exp.amount;
          }
        }

        return {
          totalAll: totalAll,
          totalMonth: totalMonth,
          count: expenses.length
        };
      }

      function updateSummaryCards() {
        const summary = calculateSummary();
        if (summaryTotalAll) {
          summaryTotalAll.textContent = currencyFormatter.format(summary.totalAll);
        }
        if (summaryTotalMonth) {
          summaryTotalMonth.textContent = currencyFormatter.format(summary.totalMonth);
        }
        if (summaryCount) {
          summaryCount.textContent = String(summary.count);
        }
      }

      function getActiveFilters() {
        return {
          category: filterCategory ? (filterCategory.value || "all") : "all",
          from: filterFrom ? (filterFrom.value || "") : "",
          to: filterTo ? (filterTo.value || "") : "",
          search: filterSearch ? filterSearch.value.trim().toLowerCase() : ""
        };
      }

      function applyFilters() {
        const filters = getActiveFilters();
        let result = expenses.slice();

        if (filters.category && filters.category !== "all") {
          result = result.filter(function (exp) {
            return exp.category === filters.category;
          });
        }

        if (filters.from) {
          const fromDate = parseDate(filters.from);
          if (fromDate) {
            result = result.filter(function (exp) {
              const d = parseDate(exp.date);
              return d && d >= fromDate;
            });
          }
        }

        if (filters.to) {
          const toDate = parseDate(filters.to);
          if (toDate) {
            const toEnd = new Date(toDate.getTime());
            toEnd.setHours(23, 59, 59, 999);
            result = result.filter(function (exp) {
              const d = parseDate(exp.date);
              return d && d <= toEnd;
            });
          }
        }

        if (filters.search) {
          result = result.filter(function (exp) {
            const haystack =
              (exp.description || "").toLowerCase() +
              " " +
              (exp.category || "").toLowerCase();
            return haystack.indexOf(filters.search) !== -1;
          });
        }

        // Sort by date desc, then id desc
        result.sort(function (a, b) {
          if (a.date === b.date) {
            return b.id - a.id;
          }
          return a.date < b.date ? 1 : -1;
        });

        return result;
      }

      function renderExpenses() {
        if (!expenseTbody || !noExpenses || !tableWrapper || !listSummary) return;

        const filtered = applyFilters();
        expenseTbody.innerHTML = "";

        if (expenses.length === 0) {
          noExpenses.textContent = "No expenses recorded yet. Add your first expense on the Add tab.";
          noExpenses.classList.remove("hidden");
          tableWrapper.classList.add("hidden");
          listSummary.textContent = "No expenses yet.";
          return;
        }

        if (filtered.length === 0) {
          noExpenses.textContent = "No expenses match the selected filters.";
          noExpenses.classList.remove("hidden");
          tableWrapper.classList.add("hidden");
          listSummary.textContent = "No expenses match your current filters.";
          return;
        }

        noExpenses.classList.add("hidden");
        tableWrapper.classList.remove("hidden");

        let totalFiltered = 0;

        for (let i = 0; i < filtered.length; i++) {
          const exp = filtered[i];
          totalFiltered += exp.amount;

          const tr = document.createElement("tr");
          tr.className = "border-b border-slate-800 hover:bg-slate-900";

          const dateTd = document.createElement("td");
          dateTd.className = "whitespace-nowrap px-3 py-2 text-slate-200";
          dateTd.textContent = formatDate(exp.date);

          const categoryTd = document.createElement("td");
          categoryTd.className = "whitespace-nowrap px-3 py-2 text-slate-100";
          categoryTd.textContent = exp.category;

          const descriptionTd = document.createElement("td");
          descriptionTd.className = "px-3 py-2 text-slate-300";
          descriptionTd.textContent = exp.description || "—";

          const amountTd = document.createElement("td");
          amountTd.className = "whitespace-nowrap px-3 py-2 text-right font-medium text-slate-50";
          amountTd.textContent = currencyFormatter.format(exp.amount);

          const actionsTd = document.createElement("td");
          actionsTd.className = "whitespace-nowrap px-3 py-2 text-right";
          const editBtn = document.createElement("button");
          editBtn.type = "button";
          editBtn.textContent = "Edit";
          editBtn.dataset.action = "edit";
          editBtn.dataset.id = String(exp.id);
          editBtn.className =
            "inline-flex items-center rounded-full border border-slate-500 px-2 py-1 text-[11px] font-medium text-slate-100 hover:bg-slate-800 mr-1";

          const deleteBtn = document.createElement("button");
          deleteBtn.type = "button";
          deleteBtn.textContent = "Delete";
          deleteBtn.dataset.action = "delete";
          deleteBtn.dataset.id = String(exp.id);
          deleteBtn.className =
            "inline-flex items-center rounded-full border border-red-500/80 px-2 py-1 text-[11px] font-medium text-red-200 hover:bg-red-950/60";

          actionsTd.appendChild(editBtn);
          actionsTd.appendChild(deleteBtn);

          tr.appendChild(dateTd);
          tr.appendChild(categoryTd);
          tr.appendChild(descriptionTd);
          tr.appendChild(amountTd);
          tr.appendChild(actionsTd);

          expenseTbody.appendChild(tr);
        }

        const countText = filtered.length === 1 ? "1 expense" : filtered.length + " expenses";
        listSummary.textContent =
          "Showing " +
          countText +
          " · Total " +
          currencyFormatter.format(totalFiltered) +
          " (after filters)";
      }

      function startEditing(id) {
        const exp = expenses.find(function (item) {
          return item.id === id;
        });
        if (!exp) return;

        editingId = id;
        if (amountInput) amountInput.value = String(exp.amount);
        if (categoryInput) categoryInput.value = exp.category || "";
        if (dateInput) dateInput.value = exp.date || getTodayDateString();
        if (descriptionInput) descriptionInput.value = exp.description || "";

        if (submitBtn) submitBtn.textContent = "Save changes";
        if (editingIndicator) editingIndicator.classList.remove("hidden");
        showFormError("");

        if (screenAdd && screenHistory) {
          setActiveTab("add");
        }

        if (expenseForm && typeof expenseForm.scrollIntoView === "function") {
          expenseForm.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      }

      function stopEditing() {
        editingId = null;
        if (submitBtn) submitBtn.textContent = "Add expense";
        if (editingIndicator) editingIndicator.classList.add("hidden");
        if (expenseForm) expenseForm.reset();
        setDefaultDate();
        showFormError("");
      }

      function handleFormSubmit(event) {
        event.preventDefault();
        showFormError("");

        if (!amountInput || !categoryInput || !dateInput || !descriptionInput) return;

        const amountValue = parseFloat(String(amountInput.value).replace(",", "."));
        if (!Number.isFinite(amountValue) || amountValue <= 0) {
          showFormError("Please enter a valid amount greater than 0.");
          amountInput.focus();
          return;
        }

        const categoryValue = categoryInput.value;
        if (!categoryValue) {
          showFormError("Please choose a category.");
          categoryInput.focus();
          return;
        }

        const dateValue = dateInput.value;
        if (!dateValue) {
          showFormError("Please select a date.");
          dateInput.focus();
          return;
        }

        const parsedDate = parseDate(dateValue);
        if (!parsedDate) {
          showFormError("Please enter a valid date.");
          dateInput.focus();
          return;
        }

        const descriptionValue = descriptionInput.value.trim();

        if (editingId !== null) {
          expenses = expenses.map(function (exp) {
            if (exp.id !== editingId) return exp;
            return {
              id: exp.id,
              amount: amountValue,
              category: categoryValue,
              date: dateValue,
              description: descriptionValue
            };
          });
        } else {
          const newExpense = {
            id: Date.now(),
            amount: amountValue,
            category: categoryValue,
            date: dateValue,
            description: descriptionValue
          };
          expenses.push(newExpense);
        }

        saveExpenses();
        updateSummaryCards();
        renderExpenses();
        stopEditing();
      }

      function handleTableClick(event) {
        const target = event.target;
        if (!(target instanceof HTMLElement)) return;
        const button = target.closest("button[data-action]");
        if (!button) return;

        const action = button.dataset.action;
        const idStr = button.dataset.id;
        const id = idStr ? Number(idStr) : NaN;
        if (!idStr || !Number.isFinite(id)) return;

        if (action === "edit") {
          startEditing(id);
        } else if (action === "delete") {
          const confirmed = window.confirm("Delete this expense? This action cannot be undone.");
          if (!confirmed) return;
          expenses = expenses.filter(function (exp) {
            return exp.id !== id;
          });
          if (editingId === id) {
            stopEditing();
          }
          saveExpenses();
          updateSummaryCards();
          renderExpenses();
        }
      }

      function handleClearAll() {
        if (expenses.length === 0) {
          return;
        }
        const confirmed = window.confirm(
          "Clear ALL expenses stored in this browser? This cannot be undone."
        );
        if (!confirmed) return;
        expenses = [];
        saveExpenses();
        stopEditing();
        updateSummaryCards();
        renderExpenses();
      }

      function handleClearFilters() {
        if (filterCategory) filterCategory.value = "all";
        if (filterFrom) filterFrom.value = "";
        if (filterTo) filterTo.value = "";
        if (filterSearch) filterSearch.value = "";
        renderExpenses();
      }

      function handleExportJson() {
        if (expenses.length === 0) {
          window.alert("There is no data to export yet.");
          return;
        }
        const blob = new Blob([JSON.stringify(expenses, null, 2)], {
          type: "application/json;charset=utf-8"
        });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        const now = new Date();
        const datePart =
          now.getFullYear() +
          "-" +
          String(now.getMonth() + 1).padStart(2, "0") +
          "-" +
          String(now.getDate()).padStart(2, "0");
        link.href = url;
        link.download = "expenses-" + datePart + ".json";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }

      function setActiveTab(name) {
        activeTab = name === "history" ? "history" : "add";

        if (screenAdd && screenHistory) {
          if (activeTab === "add") {
            screenAdd.classList.remove("hidden");
            screenHistory.classList.add("hidden");
          } else {
            screenAdd.classList.add("hidden");
            screenHistory.classList.remove("hidden");
          }
        }

        if (tabButtons && tabButtons.length) {
          tabButtons.forEach(function (btn) {
            const target = btn.getAttribute("data-tab-target");
            const indicator = btn.querySelector(".tab-indicator");
            if (target === activeTab) {
              btn.classList.remove("text-slate-400");
              btn.classList.add("text-blue-400");
              if (indicator) {
                indicator.classList.remove("opacity-0");
              }
            } else {
              btn.classList.remove("text-blue-400");
              btn.classList.add("text-slate-400");
              if (indicator) {
                indicator.classList.add("opacity-0");
              }
            }
          });
        }
      }

      function attachEventListeners() {
        if (expenseForm) {
          expenseForm.addEventListener("submit", handleFormSubmit);
        }
        if (resetFormBtn) {
          resetFormBtn.addEventListener("click", function () {
            stopEditing();
          });
        }
        if (cancelEditBtn) {
          cancelEditBtn.addEventListener("click", function () {
            stopEditing();
          });
        }

        if (expenseTbody) {
          expenseTbody.addEventListener("click", handleTableClick);
        }

        if (filterCategory) filterCategory.addEventListener("change", renderExpenses);
        if (filterFrom) filterFrom.addEventListener("change", renderExpenses);
        if (filterTo) filterTo.addEventListener("change", renderExpenses);
        if (filterSearch) {
          filterSearch.addEventListener("input", function () {
            renderExpenses();
          });
        }
        if (clearFiltersBtn) clearFiltersBtn.addEventListener("click", handleClearFilters);
        if (clearAllBtn) clearAllBtn.addEventListener("click", handleClearAll);
        if (exportJsonBtn) exportJsonBtn.addEventListener("click", handleExportJson);

        if (tabButtons && tabButtons.length) {
          tabButtons.forEach(function (btn) {
            btn.addEventListener("click", function () {
              const target = btn.getAttribute("data-tab-target");
              if (target === "add" || target === "history") {
                setActiveTab(target);
              }
            });
          });
        }
      }

      function init() {
        setTodayLabel();
        setDefaultDate();
        loadExpenses();
        attachEventListeners();
        updateSummaryCards();
        renderExpenses();
        setActiveTab("add");
      }

      init();
    })();
  </script>
</body>
</html>